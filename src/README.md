## Part 1. Инструмент **ipcalc**

**Поднимаем виртуальную машину ws1**
![alt text](image.png)

**Установка инструмента **ipcalc****
![alt text](image-1.png)

**Адрес сети 192.167.38.54/13**
![alt text](image-2.png)

**Перевод маски 255.255.255.0 в префиксную и двоичную запись, /15 в обычную и двоичную, 11111111.11111111.11111111.11110000 в обычную и префиксную**

Перевод маски в префиксной и двоичной записи можно увидеть в графе **NetMask**

255:
![alt text](image-3.png)
15:
![alt text](image-4.png)
11111111.11111111.11111111.11110000:
![alt text](image-5.png)

**Минимальный и максимальный хост в сети *12.167.38.4**

Увидеть  минимальный и максимальный хост в сети можно в строчке **HostMin** и **HostMax** соответственно.

/8:
![alt text](image-8.png)

11111111.11111111.00000000.00000000:
![alt text](image-8.png)


255.255.254.0:
![alt text](image-9.png)

/4:
![alt text](image-10.png)

1.2 localhost

Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1

**можно:**
- 127.0.0.2,
- 127.1.0.1

**нельзя:**
- 194.34.23.100,
- 128.0.0.1
Так как localhost находится в диапазоне 127.0.0.1 — 127.255.255.254

1.3 Диапазоны и сегменты сетей
частные входят в следующие диапазоны:

10.0.0.0 — 10.255.255.255

100.64.0.0 — 100.127.255.255

172.16.0.0 — 172.31.255.255

192.168.0.0 — 192.168.255.255

остальные являются публиными.

10.0.0.45 - частный

134.43.0.2- публичный

192.168.4.2 - частный

172.20.250.4 - частный

172.0.2.1 - публичный

192.172.0.1 - публичный

172.68.0.2 - публичный

172.16.255.255 - частный

10.10.10.10 - частный

192.169.168.1 - публичный

2) Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18:

Должно находиться в диапазоне 10.10.0.1-10.10.63.254

- 10.0.0.1- не подходит

**10.10.0.2 - подходит**

**10.10.10.10 - подходит**

- 10.10.100.1 - не подходит

**10.10.1.255-подходит**

## Part 2. Статическая маршрутизация между двумя машинами

**Поднимаем две виртуальные машины ws1 и ws2**
![alt text](image-11.png)

**Смотрим все существующие сетевые интерфейсы на двух машинах ws1 и ws2**
![alt text](image-12.png)

**Опиши сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12.**

Меняем конфиг **netplan** на двух машинах, так чтобы совпадало по заданиям:

![alt text](image-13.png)

Выполняем команду **netplan apply** для перезапуска сервиса сети на двух машинах.
![alt text](image-14.png)

Выполняем снова **ip a** для проверки измений.
![alt text](image-15.png)

# 2.1 Добавление статического маршрута вручную

Добавляем статический маршрут к одной машине ws1 к другой ws2, используя команду **ip r add**

![alt text](image-16.png)
К ip r add мы добавляем  их адреса машин и название сети для того чтобы связать статически их между собой.

Пингуем наши машины ws1 и ws2 между собой:
![alt text](image-17.png)

# 2.2 Добавление статического маршрута с сохранением
Перезапуск машины:
![alt text](image-18.png)

Добавляем в *etc/netplan/00-installer-config.yaml*. статический маршрут от одной машины к другой:
![alt text](image-19.png)

Пингуем машины между собой:
![alt text](image-25.png)

## Part 3 Утилита **iperf**
3.1. Скорость соединения
Перевести и записать в отчёт:

8 Mbps = 1 MB/s

100 MB/s = 819200 Kbps

1 Gbps = 1024 Mbps

# 3.2. Утилита iperf3
Измеряем скорость двух между двумя машинами (ws1 и ws2)

![alt text](image-21.png)

## Part 4 Cетевой экран

Создаем файл **firewall.sh** в папке **/etc/** имитирующий фаерволл
![alt text](image-23.png)

Выдам права на **firewall.sh** используя команду **сhmod +x**
![alt text](image-26.png)
##### Нужно добавить в файл подряд следующие правила:
##### 1) На ws1 примени стратегию, когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5).
##### 2) На ws2 примени стратегию, когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5).
##### 3) Открой на машинах доступ для порта 22 (ssh) и порта 80 (http).
##### 4) Запрети *echo reply* (машина не должна «пинговаться», т.е. должна быть блокировка на OUTPUT).
##### 5) Разреши *echo reply* (машина должна «пинговаться»).
![alt text](image-24.png)

Запускаем файрволлы на двух машинах:
![alt text](image-27.png)

В первой машине ws1 будет пинг запрещен (разрешение после запрета)
Во второй машине ws2 разрешение стоит первее чем его запрет

#### 4.2. Утилита **nmap**
##### Командой **ping** найди машину, которая не «пингуется», после чего утилитой **nmap** покажи, что хост машины запущен.

*Проверка: в выводе nmap должно быть сказано: `Host is up`*.
![alt text](image-28.png)

nmap: 
![alt text](image-29.png)

Cохраняем дампы образов машин:
ws1:
![alt text](image-30.png)
ws2:
![alt text](image-31.png)

Настрой конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.
<!-- ![alt text](image-32.png) -->
![alt text](image-33.png)
<!-- ws22 mac address:
enp0s3: 08:00:27:8a:44:10
enp0s8: 08:00:27: -->
<!-- ws21 mac address:
enp0s3: 08:00:27:3d:61:52 -->
![alt text](image-34.png)
<!-- ws11 mac address:
enp0s3: 08:00:27:5e:30:a2 -->
![alt text](image-35.png)

<!-- r2 mac address:
enp0s3: 08:00:27:78:dc:f7
enp0s8: 08:00:27:97:37:e4 -->
![alt text](image-36.png)

<!-- r1 mac address:
enp0s3: 08:00:27:a4:c4:f9
enp0s8: 08:00:27:e1:79:80 -->
![alt text](image-37.png)

Командой ip -4 a проверить, что адрес машины задан верно.
![alt text](image-38.png)

Также пропингуй ws22 с ws21. Аналогично пропингуй r1 с ws11.

![alt text](image-39.png)

![alt text](image-40.png)

# 5.2. Включение переадресации IP-адресов.
![alt text](image-41.png)

Откройте файл /etc/sysctl.conf и добавьте в него следующую строку: net.ipv4.ip_forward = 1

![alt text](image-42.png)


#### 5.3. Установка маршрута по-умолчанию

Добавляем default перед IP роутера в файле конфигураций
![alt text](image-43.png)

Вывод команды `ip r` после добавления шлюза:
![alt text](image-44.png)

Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду: tcpdump -tn -i eth1

![alt text](image-45.png)

#### 5.4. Добавление статических маршрутов
##### Добавь в роутеры r1 и r2 статические маршруты в файле конфигураций. Пример для r1 маршрута в сетку 10.20.0.0/26:


ip r:
![alt text](image-47.png)
<!-- r1:
enp0s9: 08:00:27:fe:aa:c0

r2:
enp0s9: 08:00:27:9a:0f:45 -->
![alt text](image-46.png)
##### Запусти команды на ws11:
`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`
![alt text](image-48.png)
Первый был, так как он уже прописан в нетплане и выбирается тот вариант, где маска длиннее.

#### 5.5. Построение списка маршрутизаторов

##### Запусти на r1 команду дампа:
`tcpdump -tnv -i eth0`
![alt text](image-49.png)

##### При помощи утилиты **traceroute** построй список маршрутизаторов на пути от ws11 до ws21.

Пример вывода утилиты **traceroute** после добавления шлюза:

1 | 10.10.0.1 0 ms 1 ms 0 ms
2 | 10.100.0.12 1 ms 0 ms 1 ms
3 | 10.20.0.10 12 ms 1 ms 3 ms

![alt text](image-50.png)
traceroute позволяет пользователям видеть каждый hop на пути к целевому IP-адресу и измерять время отклика для каждого hop.

#### 5.6. Использование протокола **ICMP** при маршрутизации
##### Запусти на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
`tcpdump -n -i eth0 icmp`
![alt text](image-51.png)
##### Пропингуй с ws11 несуществующий IP (например, *10.30.0.111*) с помощью команды:
`ping -c 1 10.30.0.111`
![alt text](image-52.png)
![alt text](image-54.png)

##### Сохрани дампы образов виртуальных машин.
![alt text](image-53.png)

## Part 6. Динамическая настройка IP с помощью **DHCP**

##### Для r2 настрой в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**:
![alt text](image-55.png)
##### 2) В файле *resolv.conf* пропиши `nameserver 8.8.8.8`.
![alt text](image-56.png)

#### Перезагрузи службу **DHCP** командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузи при помощи `reboot` и через `ip a` покажи, что она получила адрес. Также пропингуй ws22 с ws21.
![alt text](image-57.png)

через `ip a` покажи, что она получила адрес.
![alt text](image-58.png)

Также пропингуй ws22 с ws21.
![alt text](image-59.png)

##### Укажи MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`.
Обновление конфига
![alt text](image-60.png)

ip a до:
![alt text](image-61.png)
ip a после:
![alt text](image-63.png)

##### Для r1 настрой аналогично r2, но сделай выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Проведи аналогичные тесты.
![alt text](image-62.png)


##### Запроси с ws21 обновление ip адреса.

![alt text](image-64.png)
- В отчёте опиши, какими опциями **DHCP** сервера пользовался в данном пункте.

**sudo dhclient -v** добавить ip
**sudo dhclient -r** удалить ip

##### Сохрани дампы образов виртуальных машин.
![alt text](image-65.png)

## Part 7. **NAT**

##### В файле */etc/apache2/ports.conf* на ws22 и r1 измени строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделай сервер Apache2 общедоступным.

![alt text](image-66.png)

##### Запусти веб-сервер Apache командой `service apache2 start` на ws22 и r1.
![alt text](image-67.png)

#### Добавь в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
##### 1) Удаление правил в таблице filter - `iptables -F`;
##### 2) Удаление правил в таблице "NAT" - `iptables -F -t nat`;
##### 3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`.
##### Запусти файл также, как в Части 4.
![alt text](image-68.png)

##### Проверь соединение между ws22 и r1 командой `ping`.
![alt text](image-69.png)
*При запуске файла с этими правилами, ws22 не должна «пинговаться» с r1.*

##### Добавь в файл ещё одно правило:
##### 4) Разрешить маршрутизацию всех пакетов протокола **ICMP**.
![alt text](image-71.png)

##### Проверь соединение между ws22 и r1 командой `ping`.
![alt text](image-70.png)

*При запуске файла с этими правилами, ws22 должна «пинговаться» с r1.*

##### Добавь в файл ещё два правила:
##### 5) Включи **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0).

##### 6) Включи **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети.

![alt text](image-72.png)

##### Проверь соединение по TCP для **SNAT**: для этого с ws22 подключиться к серверу Apache на r1 командой:
![alt text](image-73.png)

#### Проверь соединение по TCP для **DNAT**: для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` (обращаться по адресу r2 и порту 8080).

![alt text](image-74.png)

##### Сохрани дампы образов виртуальных машин.
![alt text](image-75.png)


## Part 8. Дополнительно. Знакомство с **SSH Tunnels**

##### Запусти на r2 фаервол с правилами из Части 7.
![alt text](image-76.png)

##### Запусти веб-сервер **Apache** на ws22 только на localhost (то есть в файле */etc/apache2/ports.conf* измени строку `Listen 80` на `Listen localhost:80`).
![alt text](image-77.png)
##### Воспользуйся *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21.
![alt text](image-79.png)
ssh -L
![alt text](image-80.png)

##### Воспользуйся *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11.

ssh -R 


![alt text](image-81.png)


![alt text](image-82.png)


<!-- - В отчёте опиши команды, необходимые для выполнения этих четырёх пунктов, а также приложи скриншоты с их вызовом и выводом. -->

##### Сохрани дампы образов виртуальных машин.
![alt text](image-83.png)